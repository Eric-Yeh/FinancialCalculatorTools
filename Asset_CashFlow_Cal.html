<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè²¡å‹™ç¸½ç®¡ (è‚¡æ¯å‚µæ¯è‡ªå‹•åŒ–ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            /* é¡è‰²è®Šæ•¸ */
            --inc-color: #2776F5; --exp-color: #e63946;
            --asset-color: #2a9d8f; --liab-color: #f4a261;
            --dividend-bg: #e0f2f1; /* é…æ¯å€å¡ŠèƒŒæ™¯è‰² */
            --bg-color: #f8f9fa; --border-color: #dee2e6;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: var(--bg-color); display: flex; justify-content: center;
            padding: 20px; color: #333;
        }

        .container {
            background-color: white; width: 100%; max-width: 1500px; /* åŠ å¯¬ä»¥å®¹ç´é…æ¯æ¬„ä½ */
            padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 12px; margin-bottom: 50px;
        }

        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 1.8rem; }
        .subtitle { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 25px; }

        /* å·¥å…·åˆ— */
        .toolbar {
            display: flex; justify-content: flex-end; gap: 10px;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;
        }
        .btn-action {
            padding: 8px 16px; border: 1px solid #666; border-radius: 4px;
            cursor: pointer; font-size: 0.95rem; background-color: white; color: #333;
            transition: all 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-action:hover { background-color: #eee; }

        /* æ¨™é¡Œ */
        .section-title {
            font-size: 1.3rem; font-weight: bold; margin: 30px 0 15px 0;
            padding-left: 10px; border-left: 5px solid #333;
        }

        /* ä½ˆå±€ */
        .split-layout { display: flex; flex-wrap: wrap; gap: 20px; }
        .panel {
            flex: 1; min-width: 650px; /* è³‡ç”¢æ¬„ä½è®Šå¤šï¼ŒåŠ å¯¬ */
            background-color: #fff; border-radius: 8px;
            border: 1px solid var(--border-color); padding: 15px;
        }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 10px; margin-bottom: 10px; border-bottom: 2px solid #eee;
        }
        .panel-header h3 { margin: 0; font-size: 1.1rem; }

        /* é¡è‰²é‚Šæ¡† */
        .panel-asset { border-top: 5px solid var(--asset-color); }
        .panel-asset h3 { color: var(--asset-color); }
        .panel-liab { border-top: 5px solid var(--liab-color); }
        .panel-liab h3 { color: var(--liab-color); }
        .panel-income { border-top: 5px solid var(--inc-color); }
        .panel-income h3 { color: var(--inc-color); }
        .panel-expense { border-top: 5px solid var(--exp-color); }
        .panel-expense h3 { color: var(--exp-color); }

        /* è¼¸å…¥åˆ— */
        .entry-row {
            display: flex; gap: 5px; margin-bottom: 8px;
            align-items: center; position: relative; padding-bottom: 2px;
        }
        .entry-index { color: #ccc; font-size: 0.8rem; width: 20px; text-align: center; }
        .transfer-chk { width: 18px; height: 18px; cursor: pointer; accent-color: #333; }

        input, select {
            padding: 6px 5px; border: 1px solid var(--border-color);
            border-radius: 4px; outline: none; font-size: 0.85rem;
        }
        input:focus, select:focus { border-color: #555; background-color: #f0f7ff; }
        input[readonly] { background-color: #f3f3f3; color: #555; font-weight: bold; border-color: #eee; }

        /* --- æ¬„ä½å¯¬åº¦å¾®èª¿ --- */
        /* è³‡ç”¢å°ˆç”¨ */
        input.input-desc { flex: 1.5; min-width: 100px; }
        input.input-price { width: 80px; text-align: right; }
        input.input-qty { width: 60px; text-align: center; }
        input.input-total { width: 90px; text-align: right; }
        
        /* é…æ¯å°ˆç”¨å€ (ä¸åŒèƒŒæ™¯è‰²ä»¥ç¤ºå€åˆ¥) */
        .dividend-group {
            display: flex; gap: 5px; background-color: var(--dividend-bg);
            padding: 2px 5px; border-radius: 4px; border: 1px solid #b2dfdb;
        }
        input.input-div-unit { width: 70px; text-align: right; background-color: white; }
        select.input-div-freq { width: 70px; background-color: white; }

        /* ç¾é‡‘æµå°ˆç”¨ */
        input.cf-amount { flex: 1; text-align: right; }
        input.cf-period { width: 60px; text-align: center; }

        .header-row {
            display: flex; gap: 5px; margin-bottom: 8px; padding-left: 45px;
            font-size: 0.8rem; color: #666; font-weight: bold;
        }
        
        .subtotal-area {
            margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc;
            text-align: right; font-weight: bold; font-size: 1rem;
        }
        .net-worth-section, .result-section {
            margin-top: 20px; padding: 20px; border-radius: 8px; text-align: center;
        }
        .net-worth-section { background-color: #f0fdf4; border: 1px solid #bbf7d0; }
        .result-section { background-color: #eef4fc; border: 1px solid #dce9f9; }
        
        .big-number { font-size: 2.2rem; margin: 5px 0 0 0; font-weight: bold; }
        .net-worth-val { color: var(--asset-color); }
        .cash-flow-val { color: var(--inc-color); }
        .negative { color: var(--exp-color) !important; }

        .btn-reset {
            background-color: #6c757d; color: white; border: none; padding: 4px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.85rem;
        }
        .btn-reset:hover { background-color: #5a6268; }

        /* åœ–è¡¨ */
        .charts-container {
            display: flex; flex-wrap: wrap; gap: 30px; margin-top: 40px;
            padding-top: 30px; border-top: 2px dashed #eee;
        }
        .chart-wrapper {
            flex: 1; min-width: 300px; background: #fff; padding: 20px;
            border-radius: 8px; border: 1px solid #eee; display: flex;
            flex-direction: column; align-items: center;
        }
        .canvas-container { position: relative; height: 350px; width: 100%; max-width: 450px; }
        
        /* æç¤ºå­— */
        .monthly-hint {
            font-size: 0.7rem; color: #888; position: absolute;
            bottom: -10px; right: 5px; background-color: rgba(255,255,255,0.95);
            padding: 0 4px; z-index: 1;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>å€‹äººè²¡å‹™ç¸½ç®¡ (è‚¡æ¯å‚µæ¯è‡ªå‹•åŒ–ç‰ˆ)</h1>
    <p class="subtitle">è‡ªå‹•è¨ˆç®—ï¼šè‚¡æ•¸ Ã— å–®ä½é…æ¯ âœ ç¾é‡‘æµæ”¶å…¥</p>
    
    <div class="toolbar">
        <button class="btn-action download" onclick="exportData()">ğŸ“¥ å„²å­˜æª”æ¡ˆ (Save JSON)</button>
        <button class="btn-action upload" onclick="document.getElementById('file-upload').click()">ğŸ“¤ è¼‰å…¥æª”æ¡ˆ (Load JSON)</button>
        <input type="file" id="file-upload" style="display: none" accept=".json" onchange="importData(this)">
    </div>

    <div class="section-title" style="border-left-color: var(--asset-color);">è³‡ç”¢è² å‚µè¡¨</div>

    <div class="split-layout">
        <div class="panel panel-asset">
            <div class="panel-header">
                <h3>ğŸ›ï¸ è³‡ç”¢ (å«é…æ¯è¨­å®š)</h3>
                <button class="btn-reset" onclick="clearInputs('asset')">æ¸…ç©º</button>
            </div>
            <div class="header-row">
                <div style="flex:1.5;">é …ç›®åç¨±</div>
                <div style="width:80px; text-align:right;">ç¾åƒ¹</div>
                <div style="width:60px; text-align:center;">æ•¸é‡(è‚¡/å¼µ)</div>
                <div style="width:160px; text-align:center; background:#e0f2f1; border-radius:4px; margin:0 5px;">é…æ¯è¨­å®š (å…ƒ/é »ç‡)</div>
                <div style="width:90px; text-align:right;">ç¸½å¸‚å€¼</div>
            </div>
            <div id="asset-list"></div>
            <div class="subtotal-area">ç¸½è³‡ç”¢ï¼š<span id="total-asset">0</span></div>
        </div>

        <div class="panel panel-liab">
            <div class="panel-header">
                <h3>ğŸ’³ è² å‚µ</h3>
                <button class="btn-reset" onclick="clearInputs('liab')">æ¸…ç©º</button>
            </div>
            <div class="header-row">
                <div class="input-desc">é …ç›®åç¨±</div>
                <div class="input-price">å–®åƒ¹/é¤˜é¡</div>
                <div class="input-qty">æ•¸é‡</div>
                <div class="input-total">ç¸½æ¬ æ¬¾</div>
            </div>
            <div id="liab-list"></div>
            <div class="subtotal-area">ç¸½è² å‚µï¼š<span id="total-liab">0</span></div>
        </div>
    </div>

    <div class="net-worth-section">
        <div style="color:#666;">æ·¨å€¼ (Net Worth)</div>
        <h2 id="final-networth" class="big-number net-worth-val">$0</h2>
    </div>

    <div class="section-title" style="border-left-color: var(--inc-color); margin-top: 50px;">ç¾é‡‘æµé‡è¡¨</div>

    <div class="split-layout">
        <div class="panel panel-income">
            <div class="panel-header">
                <h3>ğŸ’° æ”¶å…¥</h3>
                <button class="btn-reset" onclick="clearInputs('income')">æ¸…ç©º</button>
            </div>
            <div class="header-row">
                <div class="input-desc">é …ç›®åç¨±</div>
                <div class="input-qty">æœŸæ•¸(æœˆ)</div>
                <div class="cf-amount">è©²æœŸç¸½é‡‘é¡</div>
            </div>
            <div id="income-list"></div>
            <div class="subtotal-area">æœˆå‡æ”¶å…¥ï¼š<span id="total-income">0</span></div>
        </div>

        <div class="panel panel-expense">
            <div class="panel-header">
                <h3>ğŸ’¸ æ”¯å‡º</h3>
                <button class="btn-reset" onclick="clearInputs('expense')">æ¸…ç©º</button>
            </div>
            <div class="header-row">
                <div class="input-desc">é …ç›®åç¨±</div>
                <div class="input-qty">æœŸæ•¸(æœˆ)</div>
                <div class="cf-amount">è©²æœŸç¸½é‡‘é¡</div>
            </div>
            <div id="expense-list"></div>
            <div class="subtotal-area">æœˆå‡æ”¯å‡ºï¼š<span id="total-expense">0</span></div>
        </div>
    </div>

    <div class="result-section">
        <div style="color:#666;">æ¯æœˆç¾é‡‘æµçµé¤˜ (Net Cash Flow)</div>
        <h2 id="final-cashflow" class="big-number cash-flow-val">$0</h2>
        <div id="status-text" style="margin-top:5px; font-size:0.9rem; color:#666;"></div>
    </div>

    <div class="charts-container">
        <div class="chart-wrapper">
            <h3>ğŸ“Š æ”¶å…¥åˆ†ä½ˆ</h3>
            <div class="canvas-container"><canvas id="incomeChart"></canvas></div>
        </div>
        <div class="chart-wrapper">
            <h3>ğŸ“‰ æ”¯å‡ºåˆ†ä½ˆ</h3>
            <div class="canvas-container"><canvas id="expenseChart"></canvas></div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    const ROWS_COUNT = 15;
    let incomeChartInstance = null;
    let expenseChartInstance = null;
    const chartColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8c7ae6', '#e1b12c', '#44bd32', '#0097e6', '#e84118'];

    window.onload = function() {
        generateAssetRows();
        generateLiabRows();
        generateCashRows('income-list', 'inc', 'ä¾‹å¦‚: è–ªè³‡');
        generateCashRows('expense-list', 'exp', 'ä¾‹å¦‚: æˆ¿ç§Ÿ');
        initCharts();
    };

    // --- 1. ç”Ÿæˆè³‡ç”¢æ¬„ä½ (å«é…æ¯è¨­å®š) ---
    function generateAssetRows() {
        const container = document.getElementById('asset-list');
        let html = '';
        for (let i = 1; i <= ROWS_COUNT; i++) {
            html += `
                <div class="entry-row">
                    <input type="checkbox" class="transfer-chk" title="å°‡é…æ¯å¸¶å…¥ç¾é‡‘æµ" onchange="transferDividend(this, ${i-1})">
                    <span class="entry-index">${i}.</span>
                    <input type="text" placeholder="ä¾‹å¦‚: å°ç©é›»" class="input-desc asset-desc">
                    <input type="number" placeholder="ç¾åƒ¹" class="input-price asset-price" oninput="calcAssetTotal(this)">
                    <input type="number" value="0" placeholder="è‚¡æ•¸" class="input-qty asset-qty" oninput="calcAssetTotal(this)">
                    
                    <div class="dividend-group">
                        <input type="number" placeholder="é…æ¯" title="æ¯å–®ä½é…æ¯é‡‘é¡" class="input-div-unit asset-div-unit">
                        <select class="input-div-freq asset-div-freq" title="é…æ¯é »ç‡">
                            <option value="12">å¹´é…</option>
                            <option value="6">åŠå¹´</option>
                            <option value="3">å­£é…</option>
                            <option value="1">æœˆé…</option>
                        </select>
                    </div>

                    <input type="text" placeholder="ç¸½å¸‚å€¼" class="input-total asset-total" readonly tabindex="-1">
                </div>
            `;
        }
        container.innerHTML = html;
    }

    // --- 2. ç”Ÿæˆè² å‚µæ¬„ä½ ---
    function generateLiabRows() {
        const container = document.getElementById('liab-list');
        let html = '';
        for (let i = 1; i <= ROWS_COUNT; i++) {
            html += `
                <div class="entry-row">
                    <input type="checkbox" class="transfer-chk" title="å¸¶å…¥åç¨±è‡³æ”¯å‡º" onchange="transferLiab(this, ${i-1})">
                    <span class="entry-index">${i}.</span>
                    <input type="text" placeholder="ä¾‹å¦‚: æˆ¿è²¸" class="input-desc liab-desc">
                    <input type="number" placeholder="é¤˜é¡" class="input-price liab-price" oninput="calcLiabTotal(this)">
                    <input type="number" value="1" class="input-qty liab-qty" oninput="calcLiabTotal(this)">
                    <input type="text" placeholder="ç¸½æ¬ æ¬¾" class="input-total liab-total" readonly tabindex="-1">
                </div>
            `;
        }
        container.innerHTML = html;
    }

    // --- 3. ç”Ÿæˆç¾é‡‘æµæ¬„ä½ ---
    function generateCashRows(containerId, prefix, placeholder) {
        const container = document.getElementById(containerId);
        let html = '';
        for (let i = 1; i <= ROWS_COUNT; i++) {
            html += `
                <div class="entry-row">
                    <span class="entry-index">${i}.</span>
                    <input type="text" placeholder="${placeholder}" class="input-desc ${prefix}-desc" oninput="calculateCashFlow()">
                    <input type="number" value="1" min="1" max="60" class="input-period ${prefix}-period" oninput="calculateCashFlow()" title="å¹¾å€‹æœˆç‚ºä¸€æœŸ?">
                    <input type="number" placeholder="é‡‘é¡" class="cf-amount ${prefix}-amount" oninput="calculateCashFlow()" min="0">
                    <span class="monthly-hint ${prefix}-hint"></span>
                </div>
            `;
        }
        container.innerHTML = html;
    }

    // --- è¨ˆç®—è³‡ç”¢ç¸½å€¼ ---
    function calcAssetTotal(input) {
        const row = input.parentElement;
        const price = parseFloat(row.querySelector(`.asset-price`).value) || 0;
        const qty = parseFloat(row.querySelector(`.asset-qty`).value) || 0;
        const totalInput = row.querySelector(`.asset-total`);
        let total = price * qty;
        totalInput.value = total === 0 ? "" : formatCurrency(total);
        totalInput.dataset.value = total;
        calculateBalance();
    }

    function calcLiabTotal(input) {
        const row = input.parentElement;
        const price = parseFloat(row.querySelector(`.liab-price`).value) || 0;
        const qty = parseFloat(row.querySelector(`.liab-qty`).value) || 0;
        const totalInput = row.querySelector(`.liab-total`);
        let total = price * qty;
        totalInput.value = total === 0 ? "" : formatCurrency(total);
        totalInput.dataset.value = total;
        calculateBalance();
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šé…æ¯å¸¶å…¥æ”¶å…¥ ---
    function transferDividend(checkbox, index) {
        if (!checkbox.checked) return;

        // 1. æŠ“å–è³‡ç”¢è³‡æ–™
        const desc = document.querySelectorAll('.asset-desc')[index].value.trim();
        const qty = parseFloat(document.querySelectorAll('.asset-qty')[index].value) || 0;
        const divUnit = parseFloat(document.querySelectorAll('.asset-div-unit')[index].value) || 0;
        const divFreq = document.querySelectorAll('.asset-div-freq')[index].value; // 12, 6, 3, 1 (æœˆæ•¸)

        if (!desc) { alert("è«‹è¼¸å…¥è³‡ç”¢åç¨±"); checkbox.checked = false; return; }
        if (qty === 0 || divUnit === 0) { alert("è«‹è¼¸å…¥ã€Œæ•¸é‡ã€èˆ‡ã€Œå–®ä½é…æ¯ã€æ‰èƒ½è¨ˆç®—ç¾é‡‘æµ"); checkbox.checked = false; return; }

        // 2. è¨ˆç®—ç¸½é…æ¯é‡‘é¡ (å–®æ¬¡ç™¼æ”¾é‡‘é¡)
        // æ³¨æ„ï¼šé€™è£¡çš„é‡‘é¡æ˜¯æŒ‡ã€Œæ¯æ¬¡é ˜åˆ°çš„éŒ¢ã€ï¼Œç„¶å¾Œåœ¨ç¾é‡‘æµè¡¨è¨­å®šã€ŒæœŸæ•¸ã€
        // ä¾‹å¦‚ï¼šå­£é…ï¼Œæ¯æ¬¡é ˜ = è‚¡æ•¸ * å–®ä½é…æ¯ã€‚æœŸæ•¸ = 3ã€‚
        const totalDividendPerPeriod = qty * divUnit;

        // 3. å¡«å…¥ç¾é‡‘æµ (æ”¶å…¥è¡¨)
        const targetDesc = document.querySelectorAll('.inc-desc');
        const targetPeriod = document.querySelectorAll('.inc-period');
        const targetAmount = document.querySelectorAll('.inc-amount');

        // æª¢æŸ¥é‡è¤‡
        let isDuplicate = false;
        let emptyIndex = -1;
        
        // çµ„åˆåç¨±ï¼Œä¾‹å¦‚ "å°ç©é›» (è‚¡æ¯)"
        const incomeName = `${desc} (è‚¡æ¯)`;

        for (let i = 0; i < targetDesc.length; i++) {
            if (targetDesc[i].value.trim() === incomeName) isDuplicate = true;
            if (emptyIndex === -1 && targetDesc[i].value.trim() === "") emptyIndex = i;
        }

        if (isDuplicate) return; // å·²å­˜åœ¨å°±ä¸é‡è¤‡åŠ 

        if (emptyIndex !== -1) {
            targetDesc[emptyIndex].value = incomeName;
            targetPeriod[emptyIndex].value = divFreq; // å¡«å…¥é »ç‡ (12=å¹´, 3=å­£)
            targetAmount[emptyIndex].value = totalDividendPerPeriod; // å¡«å…¥ç®—å¥½çš„é‡‘é¡
            
            calculateCashFlow(); // è§¸ç™¼è¨ˆç®—
        } else {
            alert("æ”¶å…¥åˆ—è¡¨å·²æ»¿ï¼");
            checkbox.checked = false;
        }
    }

    // --- è² å‚µå¸¶å…¥æ”¯å‡º (åƒ…åç¨±) ---
    function transferLiab(checkbox, index) {
        if (!checkbox.checked) return;
        const desc = document.querySelectorAll('.liab-desc')[index].value.trim();
        if (!desc) { alert("è«‹è¼¸å…¥åç¨±"); checkbox.checked = false; return; }

        const targetDesc = document.querySelectorAll('.exp-desc');
        let emptyIndex = -1;
        for (let i = 0; i < targetDesc.length; i++) {
            if (targetDesc[i].value.trim() === desc) return;
            if (emptyIndex === -1 && targetDesc[i].value.trim() === "") emptyIndex = i;
        }

        if (emptyIndex !== -1) {
            targetDesc[emptyIndex].value = desc;
        } else {
            alert("æ”¯å‡ºåˆ—è¡¨å·²æ»¿ï¼");
            checkbox.checked = false;
        }
    }

    // --- è¨ˆç®—é‚è¼¯ ---
    function calculateBalance() {
        let assetSum = sumDataValues('asset-total');
        let liabSum = sumDataValues('liab-total');
        let net = assetSum - liabSum;

        document.getElementById('total-asset').innerText = formatCurrency(assetSum);
        document.getElementById('total-liab').innerText = formatCurrency(liabSum);
        const netEl = document.getElementById('final-networth');
        netEl.innerText = formatCurrency(net);
        netEl.className = net >= 0 ? 'big-number net-worth-val' : 'big-number negative';
    }

    function sumDataValues(className) {
        let sum = 0;
        document.querySelectorAll(`.${className}`).forEach(inp => sum += parseFloat(inp.dataset.value) || 0);
        return sum;
    }

    function calculateCashFlow() {
        let incomeData = calcSectionDetail('inc');
        let expenseData = calcSectionDetail('exp');
        let balance = incomeData.total - expenseData.total;

        document.getElementById('total-income').innerText = formatCurrency(incomeData.total);
        document.getElementById('total-expense').innerText = formatCurrency(expenseData.total);
        const cfEl = document.getElementById('final-cashflow');
        cfEl.innerText = formatCurrency(balance);
        cfEl.className = balance >= 0 ? 'big-number cash-flow-val' : 'big-number negative';
        document.getElementById('status-text').innerText = balance >= 0 ? "æ­£ç¾é‡‘æµ" : "è² ç¾é‡‘æµ";
        
        updateChart(incomeChartInstance, incomeData.items);
        updateChart(expenseChartInstance, expenseData.items);
    }

    function calcSectionDetail(prefix) {
        const descInputs = document.querySelectorAll(`.${prefix}-desc`);
        const amountInputs = document.querySelectorAll(`.${prefix}-amount`);
        const periodInputs = document.querySelectorAll(`.${prefix}-period`);
        const hints = document.querySelectorAll(`.${prefix}-hint`);
        
        let total = 0;
        let items = [];

        amountInputs.forEach((input, index) => {
            let amount = parseFloat(input.value) || 0;
            let period = parseFloat(periodInputs[index].value) || 1;
            if(period < 1) period = 1;
            let monthly = amount / period;
            total += monthly;

            if (monthly > 0) {
                let desc = descInputs[index].value.trim() || `é …ç›® ${index+1}`;
                items.push({ label: desc, value: monthly });
                hints[index].innerText = period > 1 ? `(æœˆå‡: ${formatCurrency(monthly)})` : "";
            } else { hints[index].innerText = ""; }
        });
        return { total, items };
    }

    // --- åœ–è¡¨èˆ‡å­˜æª” ---
    function initCharts() {
        const commonOptions = {
            responsive: true, maintainAspectRatio: false, layout: { padding: 20 },
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12 } },
                datalabels: {
                    color: '#000', textAlign: 'center', font: { weight: 'bold', size: 11 },
                    formatter: (value, ctx) => {
                        let sum = 0; ctx.chart.data.datasets[0].data.forEach(v => sum += v);
                        return ctx.chart.data.labels[ctx.dataIndex] + "\n" + (value * 100 / sum).toFixed(1) + "%";
                    },
                    display: (ctx) => {
                        let sum = 0; ctx.chart.data.datasets[0].data.forEach(v => sum += v);
                        return (ctx.dataset.data[ctx.dataIndex] / sum) > 0.03; 
                    }
                }
            }
        };
        const ctxInc = document.getElementById('incomeChart').getContext('2d');
        incomeChartInstance = new Chart(ctxInc, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: chartColors, borderWidth: 1, borderColor: '#fff' }] }, options: commonOptions });
        const ctxExp = document.getElementById('expenseChart').getContext('2d');
        expenseChartInstance = new Chart(ctxExp, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: chartColors, borderWidth: 1, borderColor: '#fff' }] }, options: commonOptions });
    }

    function updateChart(chart, items) {
        items.sort((a, b) => b.value - a.value);
        chart.data.labels = items.map(i => i.label);
        chart.data.datasets[0].data = items.map(i => i.value);
        chart.update();
    }

    function exportData() {
        let data = {
            assets: getBalanceData('asset', true),
            liabilities: getBalanceData('liab', false),
            incomes: getCashData('inc'),
            expenses: getCashData('exp'),
            date: new Date().toLocaleString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `finance_auto_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
    }

    function getBalanceData(prefix, isAsset) {
        let arr = [];
        const desc = document.getElementsByClassName(`${prefix}-desc`);
        const price = document.getElementsByClassName(`${prefix}-price`);
        const qty = document.getElementsByClassName(`${prefix}-qty`);
        const divUnit = isAsset ? document.getElementsByClassName(`${prefix}-div-unit`) : null;
        const divFreq = isAsset ? document.getElementsByClassName(`${prefix}-div-freq`) : null;

        for(let i=0; i<ROWS_COUNT; i++) {
            let item = {
                desc: desc[i].value,
                price: price[i].value,
                qty: qty[i].value
            };
            if(isAsset) {
                item.divUnit = divUnit[i].value;
                item.divFreq = divFreq[i].value;
            }
            arr.push(item);
        }
        return arr;
    }

    function getCashData(prefix) {
        let arr = [];
        const desc = document.getElementsByClassName(`${prefix}-desc`);
        const amount = document.getElementsByClassName(`${prefix}-amount`);
        const period = document.getElementsByClassName(`${prefix}-period`);
        for(let i=0; i<ROWS_COUNT; i++) {
            arr.push({ desc: desc[i].value, amount: amount[i].value, period: period[i].value });
        }
        return arr;
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                fillBalanceSection('asset', data.assets, true);
                fillBalanceSection('liab', data.liabilities, false);
                fillCashSection('inc', data.incomes);
                fillCashSection('exp', data.expenses);
                alert("è¼‰å…¥æˆåŠŸï¼");
            } catch(err) { console.error(err); alert("æ ¼å¼éŒ¯èª¤"); }
            input.value = '';
        };
        reader.readAsText(file);
    }

    function fillBalanceSection(prefix, dataArr, isAsset) {
        if(!dataArr) return;
        const desc = document.getElementsByClassName(`${prefix}-desc`);
        const price = document.getElementsByClassName(`${prefix}-price`);
        const qty = document.getElementsByClassName(`${prefix}-qty`);
        const divUnit = isAsset ? document.getElementsByClassName(`${prefix}-div-unit`) : null;
        const divFreq = isAsset ? document.getElementsByClassName(`${prefix}-div-freq`) : null;

        dataArr.forEach((item, i) => {
            if(i < ROWS_COUNT) {
                desc[i].value = item.desc || '';
                price[i].value = item.price || '';
                qty[i].value = item.qty || '0';
                if(isAsset) {
                    divUnit[i].value = item.divUnit || '';
                    divFreq[i].value = item.divFreq || '12';
                }
                calcAssetTotal(price[i]); // Refresh total
            }
        });
    }

    function fillCashSection(prefix, dataArr) {
        if(!dataArr) return;
        const desc = document.getElementsByClassName(`${prefix}-desc`);
        const amount = document.getElementsByClassName(`${prefix}-amount`);
        const period = document.getElementsByClassName(`${prefix}-period`);
        dataArr.forEach((item, i) => {
            if(i < ROWS_COUNT) {
                desc[i].value = item.desc || '';
                amount[i].value = item.amount || '';
                period[i].value = item.period || '1';
            }
        });
        calculateCashFlow();
    }

    function clearInputs(type) {
        // ç°¡å–®é‡æ•´é é¢æˆ–å€‹åˆ¥æ¸…ç©º (ç•¥éç´°ç¯€ä»¥ç¯€çœç¯‡å¹…ï¼Œé‚è¼¯åŒå‰ç‰ˆ)
        location.reload(); 
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
    }
</script>

</body>
</html>