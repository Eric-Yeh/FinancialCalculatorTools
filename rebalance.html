<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è³‡çµ„åˆå†å¹³è¡¡è¨ˆç®—æ©Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #4338ca; /* é›è—è‰² */
            --buy-color: #10b981;     /* è²·å…¥ç¶  */
            --sell-color: #ef4444;    /* è³£å‡ºç´… */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 1200px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 800;
        }

        /* --- æ–°å¢ï¼šå·¥å…·åˆ—æ¨£å¼ --- */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .btn-action {
            padding: 8px 16px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            background-color: white;
            color: var(--primary-color);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .btn-action:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-action.download { background-color: #e0e7ff; }
        .btn-action.upload { background-color: #ecfdf5; border-color: var(--buy-color); color: var(--buy-color); }
        .btn-action.upload:hover { background-color: var(--buy-color); color: white; }

        /* ä¸ŠåŠéƒ¨ä½ˆå±€ */
        .top-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            flex: 1;
            min-width: 350px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .panel-header {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .left-panel { border-top: 4px solid var(--primary-color); }
        .right-panel { border-top: 4px solid #f59e0b; } /* æ©˜è‰²ä»£è¡¨ç›®æ¨™ */

        /* è¼¸å…¥åˆ—æ¨£å¼ - ç¢ºä¿å·¦å³é«˜åº¦ä¸€è‡´ */
        .row-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-row {
            display: flex;
            align-items: center;
            height: 40px; /* å›ºå®šé«˜åº¦ä»¥ç¢ºä¿å°é½Š */
            gap: 10px;
        }

        .index-badge {
            width: 24px;
            height: 24px;
            background-color: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            outline: none;
            font-size: 0.95rem;
            transition: 0.2s;
        }

        input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 56, 202, 0.1);
        }

        /* æ¬„ä½å¯¬åº¦è¨­å®š */
        .input-name { flex: 2; min-width: 80px; }
        .input-amount { flex: 1.5; min-width: 80px; text-align: right; }
        .input-ratio { flex: 1; text-align: right; }

        /* ç¸½è¨ˆåˆ— */
        .total-row {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .total-warning { color: var(--sell-color); font-size: 0.9rem; margin-left: 10px; }
        .total-ok { color: var(--buy-color); font-size: 0.9rem; margin-left: 10px; }

        /* ä¸‹åŠéƒ¨ï¼šçµæœè¡¨æ ¼ */
        .bottom-section {
            margin-top: 40px;
            border-top: 2px dashed #e5e7eb;
            padding-top: 30px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th {
            background-color: #f9fafb;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            color: #4b5563;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            text-align: center;
            border-top: 1px solid var(--border-color);
        }

        tr:nth-child(even) { background-color: #f9fafb; }

        /* èª¿æ•´å»ºè­°é¡è‰²èˆ‡å­—é‡ (ä¿®æ­£ç‚ºæ›´ç²—é«”) */
        .action-buy { 
            color: var(--buy-color); 
            font-weight: 900 !important; /* å¼·åˆ¶æœ€ç²—é«” */
            font-size: 1.05rem;
        }
        .action-sell { 
            color: var(--sell-color); 
            font-weight: 900 !important; /* å¼·åˆ¶æœ€ç²—é«” */
            font-size: 1.05rem;
        }
        .action-hold { color: #9ca3af; }

        .btn-reset {
            background-color: #6b7280;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-reset:hover { background-color: #4b5563; }

        /* åœ–è¡¨å€ */
        .charts-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }
        .chart-box {
            flex: 1;
            min-width: 300px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            height: 300px;
            position: relative;
        }
        .chart-box h3 { text-align: center; margin: 0 0 10px 0; font-size: 1rem; color: #555; }

    </style>
</head>
<body>

<div class="container">
    <h1>âš–ï¸ æŠ•è³‡çµ„åˆå†å¹³è¡¡è¨ˆç®—æ©Ÿ</h1>
    
    <!-- æ–°å¢ï¼šå·¥å…·åˆ— (åŒ¯å…¥/åŒ¯å‡º) -->
    <div class="toolbar">
        <button class="btn-action download" onclick="exportData()">
            ğŸ“¥ åŒ¯å‡ºè¨­å®š (.ARB)
        </button>
        <button class="btn-action upload" onclick="document.getElementById('file-upload').click()">
            ğŸ“¤ åŒ¯å…¥è¨­å®š (.ARB)
        </button>
        <!-- éš±è—çš„æª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡†ï¼Œé™åˆ¶ .ARB -->
        <input type="file" id="file-upload" style="display: none" accept=".ARB" onchange="importData(this)">
    </div>

    <div class="top-section">
        <!-- å·¦ä¸Šï¼šæ¨™çš„èˆ‡ç¾å€¼ -->
        <div class="panel left-panel">
            <div class="panel-header">
                <span>ğŸ“ ç›®å‰æŒå€‰ (Current)</span>
                <button class="btn-reset" onclick="clearAll()">æ¸…ç©º</button>
            </div>
            <div class="row-container" id="left-rows">
                <!-- JS ç”Ÿæˆ 10 è¡Œ -->
            </div>
            <div class="total-row">
                <span>ç¸½è³‡ç”¢å¸‚å€¼ï¼š</span>
                <span id="total-assets">$0</span>
            </div>
        </div>

        <!-- å³ä¸Šï¼šç›®æ¨™é…ç½® -->
        <div class="panel right-panel">
            <div class="panel-header">
                <span>ğŸ¯ ç›®æ¨™é…ç½® (Target %)</span>
                <span style="font-size:0.8rem; color:#666;">ç¸½å’Œéœ€ç‚º 100%</span>
            </div>
            <div class="row-container" id="right-rows">
                <!-- JS ç”Ÿæˆ 10 è¡Œ -->
            </div>
            <div class="total-row">
                <span>é…ç½®ç¸½æ¯”ä¾‹ï¼š</span>
                <div>
                    <span id="total-ratio">0%</span>
                    <span id="ratio-msg"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸‹åŠéƒ¨ï¼šçµæœèˆ‡èª¿æ•´ -->
    <div class="bottom-section">
        <h2 style="text-align: center; color: #333; margin-bottom: 20px;">å†å¹³è¡¡èª¿æ•´è¨ˆç•« (Rebalancing Plan)</h2>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="text-align: left; padding-left: 20px;">æ¨™çš„é …ç›®</th>
                        <th>ç›®å‰å¸‚å€¼</th>
                        <th>ç›®å‰ä½”æ¯”</th>
                        <th style="color:#f59e0b;">ç›®æ¨™ä½”æ¯”</th>
                        <th style="color:#f59e0b;">ç›®æ¨™å¸‚å€¼</th>
                        <th>èª¿æ•´é‡‘é¡</th>
                        <th>æ“ä½œå»ºè­°</th>
                    </tr>
                </thead>
                <tbody id="result-body">
                    <!-- JS ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>

        <!-- åœ–è¡¨æ¯”è¼ƒ -->
        <div class="charts-wrapper">
            <div class="chart-box">
                <h3>ç›®å‰é…ç½® (Current)</h3>
                <canvas id="chartCurrent"></canvas>
            </div>
            <div class="chart-box">
                <h3>ç›®æ¨™é…ç½® (Target)</h3>
                <canvas id="chartTarget"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    const ROWS_COUNT = 5;
    let chartCurrent = null;
    let chartTarget = null;
    
    // åœ–è¡¨é¡è‰²åº«
    const chartColors = [
        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', 
        '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#64748b'
    ];

    window.onload = function() {
        generateRows();
        initCharts();
    };

    function generateRows() {
        const leftContainer = document.getElementById('left-rows');
        const rightContainer = document.getElementById('right-rows');
        
        let leftHtml = '';
        let rightHtml = '';

        for (let i = 1; i <= ROWS_COUNT; i++) {
            // å·¦å´ï¼šåç¨± + é‡‘é¡
            leftHtml += `
                <div class="input-row">
                    <span class="index-badge">${i}</span>
                    <input type="text" placeholder="æ¨™çš„åç¨±" class="input-name item-name" oninput="calculate()">
                    <input type="number" placeholder="ç›®å‰é‡‘é¡" class="input-amount item-amount" oninput="calculate()" min="0">
                </div>
            `;

            // å³å´ï¼šæ¯”ä¾‹
            rightHtml += `
                <div class="input-row" style="justify-content: flex-end;">
                    <input type="number" placeholder="0" class="input-ratio item-ratio" oninput="calculate()" min="0" max="100">
                    <span style="width: 20px;">%</span>
                </div>
            `;
        }

        leftContainer.innerHTML = leftHtml;
        rightContainer.innerHTML = rightHtml;
    }

    function calculate() {
        // 1. æŠ“å–è³‡æ–™
        const names = document.querySelectorAll('.item-name');
        const amounts = document.querySelectorAll('.item-amount');
        const ratios = document.querySelectorAll('.item-ratio');

        let totalAssets = 0;
        let totalRatio = 0;
        let data = [];

        // ç¬¬ä¸€æ¬¡è¿´åœˆï¼šè¨ˆç®—ç¸½å’Œ
        for (let i = 0; i < ROWS_COUNT; i++) {
            let amt = parseFloat(amounts[i].value) || 0;
            let rat = parseFloat(ratios[i].value) || 0;
            
            totalAssets += amt;
            totalRatio += rat;
        }

        // æ›´æ–°ç¸½è¨ˆé¡¯ç¤º
        document.getElementById('total-assets').innerText = formatCurrency(totalAssets);
        const ratioDisplay = document.getElementById('total-ratio');
        const ratioMsg = document.getElementById('ratio-msg');
        
        ratioDisplay.innerText = totalRatio.toFixed(1) + "%";
        if (Math.abs(totalRatio - 100) > 0.1 && totalRatio > 0) {
            ratioDisplay.style.color = "var(--sell-color)";
            ratioMsg.innerHTML = `<span class="total-warning">âš  ç¸½å’Œé 100%</span>`;
        } else if (totalRatio > 0) {
            ratioDisplay.style.color = "var(--buy-color)";
            ratioMsg.innerHTML = `<span class="total-ok">âœ” é…ç½®æ­£ç¢º</span>`;
        } else {
            ratioDisplay.style.color = "#333";
            ratioMsg.innerHTML = "";
        }

        // ç¬¬äºŒæ¬¡è¿´åœˆï¼šè¨ˆç®—å€‹åˆ¥å·®ç•°
        let tbodyHtml = '';
        let chartLabels = [];
        let chartDataCurrent = [];
        let chartDataTarget = [];

        for (let i = 0; i < ROWS_COUNT; i++) {
            let name = names[i].value.trim();
            let amt = parseFloat(amounts[i].value) || 0;
            let targetRatio = parseFloat(ratios[i].value) || 0;

            // å¦‚æœè©²è¡Œå®Œå…¨æ²’è³‡æ–™ï¼Œå°±è·³éé¡¯ç¤º
            if (!name && amt === 0 && targetRatio === 0) continue;
            if (!name) name = `æ¨™çš„ ${i + 1}`;

            // è¨ˆç®—é‚è¼¯
            let currentRatio = (totalAssets > 0) ? (amt / totalAssets * 100) : 0;
            let targetAmount = (totalAssets * targetRatio / 100);
            let diffAmount = targetAmount - amt;

            // æº–å‚™åœ–è¡¨è³‡æ–™
            if (amt > 0 || targetRatio > 0) {
                chartLabels.push(name);
                chartDataCurrent.push(amt);
                chartDataTarget.push(targetAmount);
            }

            // æ¨£å¼è™•ç† (CSS å·²ä¿®æ­£ç‚º 900 font-weight)
            let actionClass = '';
            let actionText = '';
            let diffDisplay = formatCurrency(Math.abs(diffAmount));

            if (diffAmount > 1) { // è²·å…¥
                actionClass = 'action-buy';
                actionText = `ğŸŸ¢ è²·å…¥ ${diffDisplay}`;
            } else if (diffAmount < -1) { // è³£å‡º
                actionClass = 'action-sell';
                actionText = `ğŸ”´ è³£å‡º ${diffDisplay}`;
            } else {
                actionClass = 'action-hold';
                actionText = 'â– ç¶­æŒ';
            }

            tbodyHtml += `
                <tr>
                    <td style="text-align: left; padding-left: 20px; font-weight:bold;">${name}</td>
                    <td>${formatCurrency(amt)}</td>
                    <td>${currentRatio.toFixed(1)}%</td>
                    <td style="color:#f59e0b; font-weight:bold;">${targetRatio}%</td>
                    <td>${formatCurrency(targetAmount)}</td>
                    <td class="${actionClass}" style="opacity:0.8;">${(diffAmount>0?'+':'') + formatCurrency(diffAmount)}</td>
                    <td class="${actionClass}">${actionText}</td>
                </tr>
            `;
        }

        document.getElementById('result-body').innerHTML = tbodyHtml;
        updateCharts(chartLabels, chartDataCurrent, chartDataTarget);
    }

    function initCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                datalabels: {
                    color: '#fff',
                    formatter: (value, ctx) => {
                        let sum = 0;
                        let dataArr = ctx.chart.data.datasets[0].data;
                        dataArr.map(data => { sum += data; });
                        let percentage = (value * 100 / sum).toFixed(0) + "%";
                        // åªé¡¯ç¤ºä½”æ¯”å¤ å¤§çš„æ¨™ç±¤
                        return (value/sum > 0.05) ? percentage : null;
                    },
                    font: { weight: 'bold' }
                }
            }
        };

        const ctx1 = document.getElementById('chartCurrent').getContext('2d');
        chartCurrent = new Chart(ctx1, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: chartColors, borderWidth: 0 }] },
            options: commonOptions
        });

        const ctx2 = document.getElementById('chartTarget').getContext('2d');
        chartTarget = new Chart(ctx2, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: chartColors, borderWidth: 0 }] },
            options: commonOptions
        });
    }

    function updateCharts(labels, currentData, targetData) {
        if (!chartCurrent || !chartTarget) return;

        chartCurrent.data.labels = labels;
        chartCurrent.data.datasets[0].data = currentData;
        chartCurrent.update();

        chartTarget.data.labels = labels;
        chartTarget.data.datasets[0].data = targetData;
        chartTarget.update();
    }

    function clearAll() {
        document.querySelectorAll('input:not([type="file"])').forEach(input => input.value = '');
        calculate();
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('zh-TW', { 
            style: 'currency', 
            currency: 'TWD', 
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(num);
    }

    // --- æ–°å¢ï¼šåŒ¯å‡ºåŠŸèƒ½ (Export .ARB) ---
    function exportData() {
        let items = [];
        const names = document.querySelectorAll('.item-name');
        const amounts = document.querySelectorAll('.item-amount');
        const ratios = document.querySelectorAll('.item-ratio');

        for(let i=0; i < ROWS_COUNT; i++) {
            items.push({
                name: names[i].value,
                amount: amounts[i].value,
                ratio: ratios[i].value
            });
        }

        const data = {
            items: items,
            exportDate: new Date().toLocaleString()
        };

        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" }); // è‡ªå®šç¾©å‰¯æª”åæœ¬è³ªé‚„æ˜¯æ–‡å­—
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        // è¨­å®šæª”åç‚º .ARB
        const dateStr = new Date().toISOString().slice(0,10);
        link.download = `portfolio_${dateStr}.ARB`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // --- æ–°å¢ï¼šåŒ¯å…¥åŠŸèƒ½ (Import .ARB) ---
    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        // ç°¡å–®æª¢æŸ¥å‰¯æª”å (éå¼·åˆ¶ï¼Œä½†åœ¨UIå·²é™åˆ¶)
        if (!file.name.toLowerCase().endsWith('.arb')) {
            alert("è«‹é¸æ“‡æ­£ç¢ºçš„ .ARB æª”æ¡ˆæ ¼å¼");
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (data.items && Array.isArray(data.items)) {
                    const names = document.querySelectorAll('.item-name');
                    const amounts = document.querySelectorAll('.item-amount');
                    const ratios = document.querySelectorAll('.item-ratio');

                    data.items.forEach((item, index) => {
                        if (index < ROWS_COUNT) {
                            names[index].value = item.name || '';
                            amounts[index].value = item.amount || '';
                            ratios[index].value = item.ratio || '';
                        }
                    });
                    
                    calculate(); // é‡æ–°è¨ˆç®—
                    alert("è¨­å®šæª”è¼‰å…¥æˆåŠŸï¼");
                } else {
                    alert("æª”æ¡ˆæ ¼å¼å…§å®¹éŒ¯èª¤ï¼Œç„¡æ³•è®€å–ã€‚");
                }
            } catch (err) {
                alert("æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦ææ¯€ã€‚");
                console.error(err);
            }
            input.value = ''; // æ¸…ç©ºä»¥å…è¨±é‡è¤‡ä¸Šå‚³åŒåæª”æ¡ˆ
        };
        reader.readAsText(file);
    }
</script>

</body>
</html>
